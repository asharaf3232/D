name: Deploy SaaS Trading Platform (V4 - Final)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: SSH and Deploy
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.VPS_SSH_HOST }}
        username: ${{ secrets.VPS_SSH_USERNAME }}
        key: ${{ secrets.VPS_SSH_PRIVATE_KEY }}
        script: |
          # 1. الانتقال إلى مجلد المشروع
          cd /root/SaaS_Trader_V4 # (تأكد من أن هذا هو المسار الصحيح على الخادم)
          
          # 2. سحب آخر التحديثات من Git
          echo "Pulling latest code..."
          git fetch --all
          git reset --hard origin/main
          
          # 3. تثبيت/تحديث مكتبات Python (الخلفية)
          echo "Installing Python dependencies..."
          # (نفترض أنك تستخدم بيئة افتراضية venv)
          source venv/bin/activate
          pip install -r requirements.txt
          
          # 4. (هام) نسخ واجهة الويب
          # هذا يفترض أن مجلد 'dist' الخاص بواجهة React موجود في المستودع
          # إذا لم يكن موجوداً، يجب عليك رفعه يدوياً إلى الخادم في هذا المسار
          echo "Syncing Web UI (dist)..."
          # (تأكد من أن 'dist' موجود في المستودع أو تم بناؤه)
          
          # 5. إعادة تشغيل الخدمات الأربعة باستخدام PM2
          echo "Restarting all 4 services via PM2..."
          
          # أ. إعادة تشغيل خادم الويب (API Server)
          # (يفترض أنك بدأته بـ: pm2 start "python-dotenv -e .env gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app --bind 0.0.0.0:8000" --name "saas-api-server")
          pm2 reload saas-api-server
          
          # ب. إعادة تشغيل العامل (Bot Worker)
          # (يفترض أنك بدأته بـ: pm2 start "python-dotenv -e .env python3 bot_worker.py" --name "saas-bot-worker" --interpreter venv/bin/python3)
          pm2 reload saas-bot-worker
          
          # ج. إعادة تشغيل واجهة التليجرام (Telegram UI)
          # (يفترض أنك بدأته بـ: pm2 start "python-dotenv -e .env python3 telegram_ui_v4.1.py" --name "saas-telegram-ui" --interpreter venv/bin/python3)
          pm2 reload saas-telegram-ui
          
          # د. إعادة تشغيل مرسل الإشعارات (Telegram Notifier)
          # (يفترض أنك بدأته بـ: pm2 start "python-dotenv -e .env python3 telegram_notifier.py" --name "saas-telegram-notifier" --interpreter venv/bin/python3)
          pm2 reload saas-telegram-notifier
          
          echo "Deployment complete."
